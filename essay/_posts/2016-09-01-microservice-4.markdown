---
layout:     post
title:      "使用微服务架构重构支付网关"
subtitle:   "从SSH单体应用到微服务架构-4"
date:       2016-09-01 12:00:00
author:     "shamphone"
header-img: "img/home-bg-post.jpg"
catalog:	true
tags:		[微服务]

---

这是微服务重构支付系统的系列文章。 之前的文章请参考：

- [为什么要重构到微服务](http://blog.lixf.cn/essay/2016/08/05/microservice-1/)
- [重构中的天时地利任何](http://blog.lixf.cn/essay/2016/08/05/microservice-2/)
- [重构的准备工作](http://blog.lixf.cn/essay/2016/08/06/microservice-3/)

在支付系统改进中，我们对原有系统做了整体的评估，选择支付网关作为入手点来进行微服务架构的改进。这里详细介绍我们针对该模块的改进过程，供参考。 

## 原有系统情况

早期启动的时候，对接的支付渠道不多，所有支付渠道和支付网关都实现在一个项目中，部署在一起。其中支付网关是整个项目的核心和入手点。它为各个业务方提供支付全流程的调用接口，签约、代扣、支付、验证，都是通过这个接口来实现的。整个系统使用SSH框架，架构如下：

[![Image of Legacy System](http://blog.lixf.cn/img/in-post/arch-legacy.png)](http://blog.lixf.cn/img/in-post/arch-legacy.png)

业务流程如下：

1. 当接口被调用时， 首先执行参数校验，确认输入的参数的合法性，验证参数签名是否正确。确认过程包括调用账户、用户、支付方式、路由等服务来验证用户ID、账户、支付卡号、支付金额等参数。    
2. 根据输入的支付方式，调用支付路由服务，获取对应的支付渠道。   
3. 调用风控接口进行验证，如果有交易风险，则阻断本次交易。   
4. 生成交易记录；   
5. 调用支付渠道提供的服务执行支付。   
6. 根据支付结果，更新订单状态；  
7. 通知商户订单执行结果。   

在实现上，原有系统实现的类结构图如下：  
[![原有架构](http://blog.lixf.cn/img/in-post/gateway-legacy.jpg)](http://blog.lixf.cn/img/in-post/gateway-legacy.jpg)  

1. 采用SSH架构，支付网关实现为一个大Apache Struts Action类，和支付相关的所有业务逻辑都实现在一个项目中。   
2. 支付网关承载大量的功能，实际上，它是将API网关和业务逻辑都混在在一起实现。 签约、支付、代扣、验证，都在这一个类中实现，代码行数超过1000行，逻辑十分复杂。 
3. 除了风控是进程外调动，其他的服务都是进程内调用，通过springframework来管理各个service。
4. 最终落地调用的支付渠道，是通过抽象的接口来对网关封装渠道的差异。 

最终在这个系统中对接了有30多个渠道，类规模达到2000个。随着业务发展，问题越来越多。高峰期同时有5个渠道在并行开发，还有大量的其他渠道对接问题需要修复。多个人同时修改一个项目代码导致版本控制的工作骤增。上线频发引起服务中断也让业务方很不满。

## 微服务改进

确定