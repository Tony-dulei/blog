---
layout: post
title: "支付流程设计"
subtitle: "支付系统设计-9"
date: 2017-02-06 12:00:00
author: "shamphone"
header-img: "img/home-bg-post.jpg"
catalog: true
tags: [Fintech]

---

>  春节后回来，工作重点转到现有系统的微服务改进上。继续支付系统设计的话题。 在此也特别感谢大家对凤凰牌老熊的公众号的关注和支持，祝大家新的一年工作顺利，万事如意。 

接着回到支付系统设计的主题。阅读本文之前，有必要回顾下[支付系统设计]( http://blog.lixf.cn/essay/2016/08/08/payment-arch/ )这篇文章。从本文开始，我们将深入到支付系统各个模块的设计。 

## 支付流程

我们以收银台为例，详细说明支付的正确打开方式。 当用户提交订单后，就会被引导到收银台上。
以某东为例，手机上是这样的：  
[![京东PC收银台](http://blog.lixf.cn/img/in-post/cashier-phone-jd.png)](http://blog.lixf.cn/img/in-post/cashier-phone-jd.png)

PC上是这样的：  
[![京东收银台](http://blog.lixf.cn/img/in-post/cashier-jd.jpg)](http://blog.lixf.cn/img/in-post/cashier-jd.jpg)

从这里我们可以看出，用户进入收银台之后，首先需要选择默认的**支付方式**。 

> 支付方式指消费时付款的方式，比如现金支付、货到付款、信用卡支付、借记卡支付、扫码支付等。

那么有哪些支付方式适合在收银台上展示出来？ 或者说，收银台可以使用哪些支付方式? 再退一步，什么是收银台？ 收银台是一类**支付应用**。 

> 支付应用指提供给最终用户在特定场景下使用的产品，比如扫码收银、二维码支付、打赏、众筹、POS支付、生活缴费、信用卡返款、手机充值等。 这些应用是建立在支付产品的基础之上，直接面向最终的用户提供服务。 

每个支付应用可以用的支付方式是不一样的。比如说，扫码收银，可能仅支持微信和支付宝。POS支付，仅支持银行卡。而信用卡返款，只能从其他的借记卡上去扣款。 另外，在这个应用中，将支付方式呈现给用户时，哪个方式应该排在前面，这在支付系统中，是通过**引导路由**来实现的。 

> 引导路由是根据支付应用、收款商户、订单额度等信息来决定提供给用户的支付方式列表。 

当用户选择一种支付方式并提交支付后，支付系统开始执行扣款。那用户选择通过招行来支付，系统就会请求招行来扣款吗？ 这不一定，因为系统有可能并没有接入到招行接口。除了招行自己的接口外，第三方支付公司、银联等，也可以从招行卡上扣款。那应该使用哪个通道合适？ 这是通过**支付路由**来决定的。 

> 支付路由指根据用户选择的支付方式，结合费率、QOS等因素，选择合适的银行或者其他公司提供的支付接口来完成资金转移操作。 

通过支付路由，我们可以定位到一个落地来执行支付的银行(或者第三方支付，或者其他公司）的接口。这里有两个容易混淆的概念。 

> 支付接口，指由银行提供的用来执行支付的接口。这里要注意，对于同一家银行，除了总行可以提供一个接口，各地的分行也可以提供这个接口。 但一般来说，同一家银行的接口规范是一样的，不同的是提供接口的服务器、费率、性能等。比如，支付公司可以接入工行总行、工行上海分行、工行北京分行。  

> 支付通道，这是对支付接口的一个封装，包含合作银行以及通道成本、商户费率、QOS等信息； 

 银行和第三方支付等渠道提供给电商公司使用的接口，往往都会封装成**支付产品**。 

> 支付产品指将支付通道打包成满足某特定支付场景需求的商品，比如信用卡快捷、信用卡Moto等。 

而支付系统则是把支付通道提供的“支付产品” 使用支付路由来封装成业务需要的“支付产品”。这就是支付的核心流程。 

## 支付软件架构

支付服务是支付系统中最核心的组件。 一般来说，支付系统中对支付服务的设计，从整体上来说，可以分为三层，主要组件如下：

最顶层是支付应用层，这是提供给最终用户使用的系统。这些应用使用支付产品来构建。支付产品是本文介绍的核心，为应用层提供支付服务。 支付产品是通过支付渠道来完成支付操作。 

如下是某东的架构，红色方框部分即支付服务相关的模块。 
[![某东金融产品架构](http://blog.lixf.cn/img/in-post/arch-jd-payment.png)](http://blog.lixf.cn/img/in-post/arch-jd-payment.png)

其他几个公司在架构图中也是类似的设计。 

## 支付应用

支付应用的设计和公司的业务有关，并需要考虑在公司业务场景下的用户支付体验。目前应用最全的数支付宝，可以参观下当前已有的支付相关应用：
[![支付宝](http://blog.lixf.cn/img/in-post/arch-product.png)](http://blog.lixf.cn/img/in-post/arch-product.png)


## 支付产品

支付产品是由支付系统对支付渠道进行封装而对业务方提供的支付能力。整体上来说，可以提供如下支付产品：

**快捷支付**  
用户在完成绑卡之后，在支付的时候，不需要再输入卡或者身份信息，仅需要输入支付密码就可以完成支付。对于小额度的支付，甚至可以开通小额免密，直接完成支付。 这种支付方式不会打断用户的体验，是目前主要的在线支付方式。一般快捷支付产品是通过封装银行或者第三方支付平台提供的快捷支付接口或者代付接口来实现的。

**网银支付**  
用户在支付的时候，需要跳转到银行网银页面来完成支付。在网银页面，需要输入用户的卡号和身份信息。这种支付方式会中断用户当前的体验，一般仅用于PC Web上的支付。 网银支付是封装银行提供的网银支付来实现。

**协议支付**  
协议支付也称代收或者代扣，代收指渠道授权商户可以从用户的银行账户中扣款，一般用于定期扣款，不用于日常消费。比如水电煤气、有线电视费。协议支付是通过封装银行、第三方支付提供的代扣或者快捷接口来实现。

**平台支付**
使用微信、支付宝等第三方支付平台来完成支付。使用时，一般需要用户预先安装支付平台系统（手机上），注册并登录到第三方支付平台，并且已经在该平台上完成绑卡等操作。 由于微信、支付宝已经被大量使用，用户也产生对这些平台的信任，平台支付往往是电商公司的主要支付方式。 

**外卡支付**
对于由海外支付的需求，还需要提供外卡支付支持。 国内不少支付渠道都能支持外卡支付，如支付宝全球购等。直接对接Paypal，也是目前用的最多的外卡支付渠道。 关于外卡支付，以后会有专文介绍。 

**话费支付**
对于有包月小额类型的支付，手机话费也是一个不错的选择。目前也有一些平台可以支持话费支付，比如虹软、联动优势等。 

**虚币支付**
不少公司会有自己的虚拟币，比如京豆、Q币等。这些虚币也可以作为一种支付方式。

**账户支付**
也成为余额支付、零钱支付等。 指为用户建立本地账户， 支持充值，之后可以使用这个账户来完成支付。 

**信用支付**
如京东的白条，蚂蚁花呗等，指使用信用账户进行透支，类似信用卡支付。 

**代付**
和代扣相反，代付是平台将钱打给用户。 


[![支付宝](http://blog.lixf.cn/img/in-post/arch-pay-product.jpg)](http://blog.lixf.cn/img/in-post/arch-pay-product.jpg)


