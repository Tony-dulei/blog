---
layout: post
title: "支付清结算之账户和账务系统设计"
subtitle: "支付清结算-4"
date: 2017-02-03 12:00:00
author: "shamphone"
header-img: "img/home-bg-post.jpg"
catalog: true
tags: [支付清结算]

---

> 2016年10月8日从IT系统设计角度写了一篇[账户设计](http://blog.lixf.cn/essay/2016/10/08/account-1/)的文章。这里结合清结算的业务，详细介绍账户体系和账务系统的设计。

这是清结算系列的第四篇文章，前三篇文章重点在讲解业务，这一篇我们来说说系统设计。 请务必阅读这几篇文章以便理解这里的设计。

-  [支付清结算之基本概念和入门](http://blog.lixf.cn/essay/2017/01/02/clearing-basic/)
-  [支付清结算之渠道侧处理](http://blog.lixf.cn/essay/2017/01/15/clearing-channel/)
-  [支付清结算之电商侧处理](http://blog.lixf.cn/essay/2017/01/24/clearing-accounting/)

## 账户体系

在设计清结算系统前，首先需要完成账户体系的梳理。 账户是用来记录会计科目所反映的业务内容的工具，它根据会计科目来开设的。 账户有多种维度的分类。 按照经济内容来说，账户分为资产类账户、负债类账户、所有者权益类账户、损益类账户、成本类账户和共同类账户。 按照会计周期内期末是否有余额，也分为实账户和虚账户。

**资产类账户**  

用来反映资产增加、减少以及增减变动结果的账户。和支付系统相关的主要资产类账户有： 银行存款、应收账款、预付账款、库存商品、发出商品等。 这些项目一般都是实账户， 资产增加登记在借方，减少登记在贷方，期末有余额的话，一般出现在借方。 在一个会计期间，所有借方金额的累加为“借方本期发生额”，所有贷方金额的累加为“贷方本期发生额”。

```hbs
资产账户的余额=借方期初余额+借方本期发生额-贷方本期发生额。
```

为了跟踪在每个银行的存款变更情况， 需要对公司在各个银行开通的收款账户设置对应的银行存款账户、应收账款账户。

**负债类账户**  

负债类账户也是实账户，记账规则跟资产类相反，负债增加记为贷，负债减少记为借，期末如有余额，一般在贷方，表明期末有债务实有额，负债类账户的余额计算：

```hbs
贷方期末余额=贷方期初余额+贷方本期发生额-借方本期发生额。
```
从支付系统的角度， 电商公司的自有账户，包括针对个人的账户和针对商户的账户，一般放在负债类账户下，此外，应付账款、预收账款、应交税费等，也是负债类账户。

**所有者权益类账户**  

所有者权益类账户用来反映所有者权益增加、减少和变动结果的账户， 记账规则跟负债类账户一致：所有者权益增加记为贷，减少记为借。和支付系统有关的所权账户包括 本年利润、利润分配等账户。
企业取得的收入最终会使得所有者权益增加，因此收入类账户的记账方法跟所有者权益一致：增加记为贷，减少或者转销记为借，通常该账户期末无余额（因为期末收入都会转为所有者权益，如未分配利润等），属于虚账户。

**损益类账户**  

损益类账户分为收入类和费用类账户。

收入类账户指各种收入、补贴、投资收益，如主营业务收入、其他业务收入和营业外收入等，增加记为贷，减少记为借。

企业在日常经营活动中会发生各种各样的耗费，这些耗费在会计学上称为成本费用，它们是收入的抵减项目，在抵销收入之前，可以视为一种资产，因此成本费用类账户的记账规则跟资产类一样：增加记为借，减少或者转销记为贷。费用类账户包括：主营业务成本、其他业务成本、营销费用等。

按照企业会计制度的规定，损益类账户的科目余额，应该结转入利润分配科目，期末余额为零，为虚账户。

**成本类账户**  

有成本核算的企业需要设立的账户，包括生产成本、劳务成本等，本文暂不涉及。

**共同类账户**  

这是反映特殊经济业务的账户， 本文暂不涉及。

[![账户体系](http://blog.lixf.cn/img/in-post/clearing-act-arch.jpg)](http://blog.lixf.cn/img/in-post/clearing-act-arch.jpg)

## 支付流程

接着之前的小明购买会员卡的案例，不考虑优惠券和卡采购的情况，会计分录：  

```hbs
借： 应收账款-工行收款 100-100*0.1% = 99.9
     服务成本-工行手续费 100*0.1% = 0.1
贷： 主营业务收入-会员卡 100
```

在线上的实时处理流程如下：

1.  用户购买会员卡，提交订单，会员卡向订单系统请求生成订单，订单系统向支付系统发出支付请求；  
2.  支付系统生成支付记录，并向银行发出请求；    
3.  银行实时从小明的银行卡账户上扣款100元，通知支付系统小明支付成功；  
4.  支付系统账务子系统在自己的账户体系中记录小明的这一笔消费支出，给会员卡业务账户增加对应的资金，通知会员卡系统发送卡给小明。  
5.  支付系统发送消息异步通知会计系统进行记账。  

这5个步骤都是线上的流程，我们逐步分析这里涉及到的对象。 

## 支付订单

这个流程中，首先生成的是支付订单。这是一个比较简单的订单，仅涉及到一个商家和一个商品。 在比较复杂的电商场景中，一个订单会涉及到多个商家、多种商品以及对应的优惠活动。如下图所示：  

[![支付订单](http://blog.lixf.cn/img/in-post/clearing-order.jpeg)](http://blog.lixf.cn/img/in-post/clearing-order.jpeg)

也就是，一个总订单会被拆分为多个子订单。这部分内容将在后续的订单系统设计一文中详细介绍。 而订单中和资金相关的内容，都需要在账户体系中建立对应的科目和账户。在请求支付时，只会将总订单提交支付，拆分子订单是在订单系统中完成的。  
针对上述场景，为了简化处理，我们假定系统生成了如下订单：

订单号 | 下单时间 | 总支付金额 | 总运费 
-----|-----|-----|---
1000001| 2017-02-03 11:00:09 | 100.00 | 0 

## 支付记录

在这个流程中，订单系统向支付系统请求支付时，支付系统将产生支付记录（支付订单）。 支付记录内容比较多，这些数据是后续进行记账的基础。 
[![支付记录](http://blog.lixf.cn/img/in-post/clearing-record.jpeg)](http://blog.lixf.cn/img/in-post/clearing-record.jpeg)

针对本案例，产生的支付记录的主要字段：

订单号 | 支付流水号 | 创建时间 |支付时间 | 支付方式 | 支付渠道 | 记账凭证 | 对账凭证  
-------|------------|----------|---------|----------|----------|----------|---------
1000001|20170203110009001| 2017-02-03 11:00:09 | 2017-02-03 11:00:09 | 快捷支付-工商行| 快捷支付-工商行 | P2000001 | P30001

这里需要注意的几个属性：

1.  订单号: 这是总订单号。支付系统不再对订单进行拆分。 
2.  支付流水号：在支付记录中，针对每个（总）订单号，会有对应的支付流水号。 如果用户使用组合支付，如上述场景，小明使用余额支付了20元，使用银行卡支付了剩余的80元，那这将产生2个支付流水号。为了避免洗钱风险，简化订单处理，包括淘宝在内，现在一般都不再提供组合支付的支持。  
3.  支付方式和支付渠道： 用户选择的支付方式和实际执行支付的渠道可以是不一样的。比如用户选择了农行支付，但实际上电商公司没有直接对接农行，而是通过银联来对接， 那对应的支付渠道就是银联。 
3.  本条记录在支付成功后，会产生记账凭证和对账凭证。 这一条记录将产生多条会计分录，记账凭证是关联这些会计分录和支付记录的字段。对账凭证是根据对账周期来分配的。在日切后，对账凭证号相应的也会做更新。 

在产生支付记录后，在上述流程的第5步通过消息机制来异步触发记账流程。账务系统接收到记账消息后，开始更新账户信息。记账分为两个阶段：  
- **支付记账**，针对线上的账户实时更新的需求，需要让用户及时看到账户余额和订单状态，账务信息记录到用户和商户上，采用单边账的形式。  
- **会计记账**，采用复式记帐法，满足会计记账需求，记录会计分录和余额，为对账和清结算提供支持。  

在介绍记账的实现之前，我们有必要先了解下账户的结构。

## 账户结构

如前述文章介绍，我们采用复式借贷记账法。对于分户账，或者说明细账，如下示例：

**应收账款-工行收款**

日期 | 凭证号数 | 摘要 | 借方 | 贷方 | 借或贷 | 余额
-----|-----------|---------|---------|------------|-----------|--------
2017-01-12 12:30:21 | P2000001 | 购买会员卡 | 99.9|  | 借 | 8394.7
2017-01-12 12:32:23 | P2000002 | 购买会员卡 | 99.9|  | 借 | 8494.6
2017-01-12 12:33:34 | P2000003 | 购买会员卡 | 99.9|  | 借 | 8594.5
... | ... | ... | ...| ...| ..| ...
- | -|  本期发生额及余额| 9990 | 0 |- | 88398.5

在这个实例中， 账户中账务相关的结构包括：
- 账户名称：如上述的“应收账款-工行收款”  
- 会计分录： 除了登记借方金额、贷方金额，还需更新账户余额  
- 期末借方余额、期末贷方余额、期末余额：按期定时计算。在日切时，计算日发生额和余额。在按月、季度和年作为会计周期时也采用类似的方法处理。 除了日切是必须的，其它时间段的处理是根据财务需要来实现。

在实现上，账户的各个属性更新时间并不一致，所以在设计账户表的时候，可以按照更新时机来划分表。

参考 [账户设计](http://blog.lixf.cn/essay/2016/10/08/account-1/) 一文， 总的来说，账户的结构如下图所示，包括基本信息、关联实体、权限控制、余额和账务相关信息。

[![账户结构](http://blog.lixf.cn/img/in-post/clearing-accounts.jpg)](http://blog.lixf.cn/img/in-post/clearing-accounts.jpg)

在存储上，账务相关信息一般是和账户其他信息相互独立处理，处理账务相关信息的子系统被称为为账务子系统或者记账子系统。 

## 支付记账

支付记账是在支付流程中完成的，目的是让用户完成购买后，能够立即看到支付结果和账户余额。为了提升性能，支付记账一般采用单边账的形式，即将会计分录登记在用户侧或者商户侧。

在上述案例中，第6步处理，在服务器上与银行侧同步登记一笔从小明银行卡的支出，并在会员业务账户上登记一笔收入。
如果使用的是零钱支付，这一个步骤就很重要，从零钱账户上扣除费用计算余额，添加对应的消费记录，是在一个事务中完成。

##会计记账

会计记账采用复式记账，不同业务记账方式也不一样。小明买卡的案例中，需要记录的条目有：

- 在工行收款账户下，登记 99.9的借记 条目

- 在工行手续费的账户下，登记0.1元的借记条目

- 在主营业务收入-会员卡的账户下，登记100元的贷记条目。

这3条记录是通过事务处理一次生成。

日期 | 凭证号数 | 科目 | 摘要 | 借方 | 贷方 | 借或贷 
-----|-----------|---------|---------|------------|-----------|--------
2017-01-12 12:30:21 | P2000001 | 工行收款 | 购买会员卡 | 99.9|  | 借 | 8394.7
2017-01-12 12:30:21 | P2000001 | 工行手续费 | 购买会员卡 | 0.1|  | 借 | 8494.6
2017-01-12 12:30:21 | P2000001 | 主营业务收入-会员卡 | 购买会员卡 | | 100  | 贷 | 8594.5

实际实现上，科目一列，使用账号ID来替代。 

## 交易对账

支付系统每天定点执行对账，拉取工行对账单，核对交易流水。与此同时，按照从工行获取的对账单，记录资金归集的账务：
```hbs
借：  银行存款-工行  2,000,000-2,000= 1,998,000
贷： 应收账款-工行收款 1,998,000
 ```
这里将应收账款的资金转移到银行存款中去，同时将各个对账交易设置为已核实的状态。  详细实现参考[支付系统的对账处理](http://blog.lixf.cn/essay/2016/10/10/account-2-reconciliation/)

## 试算平衡和日切

每天定点系统执行日切，日切时计算：

- 各个账户的日资金汇总，计算借方，贷方余额和期末余额。

所有账户借方期初余额=所有账户贷方期初余额
所有账户借方发生额=所有账户贷方发生额
所有账户借方期末余额=所有账户贷方期末余额
账户期初余额+账户当日发生额=账户期末余额

从科目维度：
科目期初余额+科目当日发生额=科目期末余额
下级科目余额总和=上级科目余额（科目总分检查）

头条的同学们，记得帮忙点赞啊。

头条的同学帮忙点个赞，谢谢。